#!/bin/bash

COMMAND_NAME="git jira"
COMMAND_JIRA="jira"
JIRA_QUERY="project = ${JIRA_PROJECT} AND status IN('To Do', 'In Progress') ORDER BY rank asc, created"

# if [ -f "$HOME/.jira.d/config.yml" ];then
  # JIRA_PROJECT=$(grep -e ^project < "$HOME"/.jira.d/config.yml | awk '{print $2}')
# fi

if ! command -v "$COMMAND_JIRA">/dev/null 2>&1;then
  echo "You need to install https://github.com/go-jira/jira to make this script work"
  exit 1
fi

if ! command -v fzf > /dev/null 2>&1;then
  echo "You need to install https://github.com/junegunn/fzf to make this script work"
  exit 1
fi

helpFunction()
{
  echo ""
  echo "Usage: ${COMMAND_NAME} <TICKET>"
  printf "\t-n Create a jira ticket"
  printf "\t-s Create branch from ticket"
  printf "\t-p Jira Project"
  exit 1 # Exit script after printing help
}

while getopts "nsp:" opt
do
  case "$opt" in
    ? ) helpFunction;;
  esac
done

shift "$(( OPTIND - 1 ))"

JIRA_TICKET=$(jira list --query "${JIRA_QUERY}" | fzf | tr -d ":" | awk '{print $1}')

if [ -z "$JIRA_TICKET" ];then
  echo "You need to supply a jira ticket, ${COMMAND_NAME}"
  exit 1
fi

JIRA_SUMMARY=$("$COMMAND_JIRA" req --gjq fields.summary "/rest/api/2/issue/${JIRA_TICKET}")
if [ -z "$JIRA_SUMMARY" ];then
  echo "Could not find jira ticket ${JIRA_TICKET}."
  exit 1
fi

GIT_BRANCH_NAME=$(
  echo "$JIRA_SUMMARY" |
  sed -e 's/[^ a-zA-Z0-9]//g' |
  tr -s "[:space:]" '-' |
  cut -c1-64 |
  sed 's/-$//' |
  awk -v jt="$JIRA_TICKET" '{printf "%s/%s", jt, tolower($1)}'
)

if [ ${#GIT_BRANCH_NAME} -gt 20 ];then
  read -r -p "Edit branch name: " -i " $GIT_BRANCH_NAME" -e GIT_BRANCH_NAME
fi

echo git checkout -b "${GIT_BRANCH_NAME}" && \
  echo git push -u origin "${GIT_BRANCH_NAME}"

echo "Created git branch: ${GIT_BRANCH_NAME}"
# vim: filetype=sh
