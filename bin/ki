#!/usr/bin/env bash

while getopts ":n" opt; do
  case $opt in
    n)
      should_notify=1
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

# Shift all arguments away from $@
shift $((OPTIND-1))

kitchen_test_notification() {
  local _title='Kitchen CI'
  local _subtitle="Testing suite $2"
  local _msg_success="âœ… SUCCESS"
  local _msg_failure="ðŸ”´ FAILURE"
  local _msg=''
  local _command="/usr/local/bin/terminal-notifier"
  local _activate="com.googlecode.iterm2"
  echo $_subtitle
  if [ $1 = 'success' ];then
    local _msg=$_msg_success
  else
    local _msg=$_msg_failure
  fi
  if hash $_command &> /dev/null; then
    $($_command -title "${_title}" -subtitle "${_subtitle}" -message "${_msg}" -activate "${_activate}" &> /dev/null)
  fi
  if hash "push" &> /dev/null; then
    if [ $should_notify ]; then
      $(which push) "${_title} ${_subtitle}: ${_msg}"
    fi
  fi
}

ki() {
  local arguments=( "$@" )
  if [[ "${arguments[0]}" =~ ^co?n?v?e?g?e?$ ]];then
    arguments[0]='converge'
  elif [[ "${arguments[0]}" =~ ^ve?r?i?f?y?$ ]];then
    arguments[0]='verify'
  fi
  bundle exec kitchen ${arguments[@]}
  local _kitchen_exit_status=$?
  if [[ "${arguments[0]}" = 'verify' || ${arguments[0]} -eq 'test' || ${arguments[0]} -eq 'converge' ]]; then
    if [ "${_kitchen_exit_status}" -gt 0 ]; then
      kitchen_test_notification "fail" "${arguments[1]}"
    else
      kitchen_test_notification "success" "${arguments[1]}"
    fi
  fi
  exit $_kitchen_exit_status
}

ki $@
